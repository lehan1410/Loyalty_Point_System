<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Đặt lại mật khẩu — Mall</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f5f9ff;
            --accent: #2563eb;
            --muted: #6b7280;
            --card: #fff;
            --danger: #ef4444;
            --success: #10b981
        }

        * {
            box-sizing: border-box;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
        }

        body {
            margin: 0;
            background: linear-gradient(180deg, var(--bg), #fff);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 28px
        }

        .card {
            width: 100%;
            max-width: 520px;
            background: var(--card);
            border-radius: 12px;
            padding: 28px;
            box-shadow: 0 8px 30px rgba(2, 6, 23, 0.06)
        }

        h1 {
            margin: 0 0 6px 0;
            color: var(--accent);
            font-size: 28px
        }

        p.desc {
            margin: 0 0 18px 0;
            color: var(--muted)
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #374151
        }

        .input {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #e6e9ef;
            background: #fff
        }

        .input input {
            border: 0;
            outline: none;
            width: 100%;
            font-size: 15px;
            padding: 4px 0
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 11px 14px;
            border-radius: 10px;
            border: 0;
            background: linear-gradient(90deg, var(--accent), #1e40af);
            color: #fff;
            font-weight: 700;
            cursor: pointer
        }

        .msg {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: none;
            font-size: 14px
        }

        .msg.error {
            background: #fff4f4;
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.12)
        }

        .msg.success {
            background: #f0fdf4;
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.08)
        }

        .small-note {
            font-size: 13px;
            color: var(--muted);
            margin-top: 10px
        }
    </style>
</head>

<body>
    <div class="card" role="main" aria-labelledby="title">
        <h1 id="title">Đặt lại mật khẩu</h1>
        <p class="desc">Nhập mật khẩu mới. Mã xác thực được lấy từ link trong email.</p>

        <div id="msg" class="msg" role="alert"></div>

        <form id="resetForm" onsubmit="return false;">
            <label for="password">Mật khẩu mới</label>
            <div class="input"><input id="password" type="password" placeholder="Ít nhất 8 ký tự" required></div>

            <label for="confirm">Xác nhận mật khẩu</label>
            <div class="input"><input id="confirm" type="password" placeholder="Nhập lại mật khẩu" required></div>

            <div style="margin-top:14px;display:flex;gap:10px;align-items:center">
                <button id="btnSubmit" class="btn" type="submit">Cập nhật mật khẩu</button>
                <div id="spinner"
                    style="display:none;width:18px;height:18px;border:3px solid rgba(255,255,255,0.35);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite">
                </div>
            </div>

            <p class="small-note">Nếu link đã hết hạn, yêu cầu đặt lại mật khẩu mới từ trang Quên mật khẩu.</p>
        </form>
    </div>

    <script>
        function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }
        function showMessage(type, text) {
            const el = document.getElementById('msg'); el.className = 'msg ' + (type === 'error' ? 'error' : 'success'); el.textContent = text; el.style.display = 'block';
        }
        function clearMessage() { const el = document.getElementById('msg'); el.style.display = 'none'; el.textContent = ''; }

        async function submitReset() {
            clearMessage();
            const password = document.getElementById('password').value;
            const confirm = document.getElementById('confirm').value;
            if (!password || !confirm) return showMessage('error', 'Vui lòng nhập cả 2 trường.');
            if (password.length < 8) return showMessage('error', 'Mật khẩu phải tối thiểu 8 ký tự.');
            if (password !== confirm) return showMessage('error', 'Mật khẩu xác nhận không khớp.');

            const token = getQueryParam('token');
            const email = getQueryParam('email'); // optional
            if (!token) return showMessage('error', 'Thiếu mã xác thực. Vui lòng dùng link hợp lệ.');

            const btn = document.getElementById('btnSubmit'); const spinner = document.getElementById('spinner');
            btn.disabled = true; spinner.style.display = 'inline-block';

            try {
                const res = await fetch('/user/reset_password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, email, new_password: password })
                });
                const data = await res.json().catch(() => null);
                if (res.ok && data && data.success) {
                    showMessage('success', data.message || 'Bạn đã cập nhật mật khẩu thành công. Đang chuyển hướng tới đăng nhập...');
                    setTimeout(() => window.location.href = '/login', 1400);
                } else {
                    showMessage('error', (data && (data.message || data.error)) || 'Cập nhật thất bại. Vui lòng thử lại.');
                }
            } catch (err) {
                console.error(err); showMessage('error', 'Không thể kết nối tới server. Vui lòng thử lại.');
            } finally { btn.disabled = false; spinner.style.display = 'none'; }
        }

        document.getElementById('resetForm').addEventListener('submit', (e) => { e.preventDefault(); submitReset(); });
        (function () { const s = document.createElement('style'); s.innerHTML = '@keyframes spin{to{transform:rotate(360deg);}}'; document.head.appendChild(s); })();
    </script>
</body>

</html>