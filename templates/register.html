<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Register - Loyalty Point System</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg1: #f5f9ff;
            --accent: #2563eb;
            --accent-dark: #1e40af;
            --muted: #6b7280;
            --card: #ffffff;
            --success: #10b981;
            --danger: #ef4444;
        }

        * {
            box-sizing: border-box;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: linear-gradient(180deg, var(--bg1), #ffffff);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Center container */
        .wrap {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 28px;
        }

        /* Card layout */
        .card {
            width: 100%;
            max-width: 980px;
            display: grid;
            grid-template-columns: 1fr 480px;
            /* slightly narrower form column for balance */
            gap: 30px;
            /* more breathing room between panel & form */
            align-items: stretch;
        }

        /* Left panel */
        .panel {
            background: linear-gradient(180deg, rgba(37, 99, 235, 0.06), rgba(37, 99, 235, 0.02));
            border-radius: 14px;
            padding: 40px;
            /* bigger padding */
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 20px;
            /* spacing inside panel */
            box-shadow: 0 8px 30px rgba(16, 24, 40, 0.06);
            min-height: 420px;
        }

        .panel h1 {
            font-size: 44px;
            margin: 0;
            color: var(--accent);
            line-height: 1;
        }

        .panel p {
            margin: 0;
            color: var(--muted);
            font-size: 15px;
        }

        /* Form card */
        .form-card {
            background: var(--card);
            border-radius: 14px;
            padding: 30px 28px;
            /* slightly tighter vertical padding */
            box-shadow: 0 10px 35px rgba(2, 6, 23, 0.06);
            display: flex;
            flex-direction: column;
            gap: 18px;
            /* more space between form sections */
        }

        .brand {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 8px;
        }

        .logo {
            width: 56px;
            height: 56px;
            border-radius: 10px;
            flex: none;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
        }

        h2.title {
            margin: 0;
            font-size: 20px;
        }

        p.subtitle {
            margin: 0;
            color: var(--muted);
            font-size: 13px;
        }

        /* form elements spacing */
        .field {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        /* increased margin-bottom */
        label {
            font-size: 13px;
            color: #374151;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .input {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            /* larger click target */
            border-radius: 10px;
            border: 1px solid #e6e9ef;
            background: #fff;
            transition: box-shadow .15s, border-color .15s;
        }

        .input:focus-within {
            box-shadow: 0 8px 22px rgba(37, 99, 235, 0.06);
            border-color: rgba(37, 99, 235, 0.48);
        }

        .input svg {
            flex: none;
            opacity: 0.75;
            width: 18px;
            height: 18px;
        }

        .input input {
            border: 0;
            outline: none;
            font-size: 15px;
            color: #111827;
            width: 100%;
            background: transparent;
            padding: 6px 0;
        }

        /* helper / small note */
        .small-note {
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
        }

        .row-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: var(--muted);
            margin-top: 8px;
        }

        .remember {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: var(--muted);
        }

        .remember input {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 14px;
            border-radius: 10px;
            border: 0;
            background: linear-gradient(90deg, var(--accent), var(--accent-dark));
            color: white;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.12);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .muted-link {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
            font-size: 13px;
        }

        .muted-link:hover {
            text-decoration: underline;
        }

        .helper {
            font-size: 13px;
            color: var(--muted);
        }

        .error {
            background: #fff4f4;
            border: 1px solid rgba(239, 68, 68, 0.12);
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            display: none;
        }

        .success {
            background: #f0fdf4;
            border: 1px solid rgba(16, 185, 129, 0.08);
            color: var(--success);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            display: none;
        }

        .links {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-top: 10px;
        }

        /* responsive: stack & increase spacing on mobile */
        @media (max-width:860px) {
            .card {
                grid-template-columns: 1fr;
                max-width: 560px;
                gap: 18px;
            }

            .panel {
                order: 2;
                padding: 20px;
                min-height: 180px;
            }

            .form-card {
                order: 1;
                padding: 20px;
            }

            .panel h1 {
                font-size: 34px;
            }

            .field {
                margin-bottom: 14px;
            }

            .input {
                padding: 12px;
            }
        }

        /* spinner small */
        .spinner {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.35);
            border-top-color: rgba(255, 255, 255, 0.95);
            animation: spin .8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>

</head>

<body>
    <div class="wrap">
        <div class="card">

            <!-- Left panel (info) -->
            <div class="panel" aria-hidden="false">
                <div class="brand">
                    <div class="logo" aria-hidden="true">LPS</div>
                    <div>
                        <h1>Loyalty Point System</h1>
                    </div>
                </div>

                <p style="margin-top:6px;">
                    Tạo tài khoản để truy cập dashboard quản trị — quản lý chiến dịch, hợp tác brand, và cấu hình chương
                    trình tích điểm.
                </p>

                <div style="display:flex;gap:12px;margin-top:12px;">
                    <div
                        style="flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.85);box-shadow:0 4px 14px rgba(2,6,23,0.04);">
                        <div style="font-weight:700;color:#0f172a;font-size:14px;">Đơn giản</div>
                        <div style="font-size:13px;color:var(--muted);margin-top:6px;">Đăng ký nhanh, tích hợp mã giới
                            thiệu (referral).</div>
                    </div>
                    <div
                        style="flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.85);box-shadow:0 4px 14px rgba(2,6,23,0.04);">
                        <div style="font-weight:700;color:#0f172a;font-size:14px;">Bảo mật</div>
                        <div style="font-size:13px;color:var(--muted);margin-top:6px;">Mật khẩu được mã hóa; xác thực bổ
                            sung có thể cấu hình.</div>
                    </div>
                </div>
            </div>

            <!-- Right: register form -->
            <div class="form-card" role="region" aria-labelledby="register-heading">
                <div style="display:flex;align-items:center;justify-content:space-between;">
                    <div>
                        <h2 id="register-heading" class="title">Tạo tài khoản</h2>
                        <p class="subtitle">Nhập thông tin để bắt đầu — có mã giới thiệu? điền ở dưới.</p>
                    </div>

                </div>

                <div id="errorBox" class="error" role="alert" aria-live="polite"></div>
                <div id="successBox" class="success" role="status" aria-live="polite"></div>

                <form id="registerForm" autocomplete="on" onsubmit="return false;">
                    <!-- fullname -->
                    <div class="field">
                        <label for="fullname">Họ và tên</label>
                        <div class="input" title="Họ và tên">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                <path d="M12 12c2.7 0 4.9-2.2 4.9-4.9S14.7 2.2 12 2.2 7.1 4.4 7.1 7.1 9.3 12 12 12z"
                                    fill="#9CA3AF" />
                                <path d="M4 20.4c0-3.3 4.1-5 8-5s8 1.7 8 5v.6H4v-.6z" fill="#9CA3AF" />
                            </svg>
                            <input id="fullname" name="fullname" type="text" placeholder="Nguyễn Văn A"
                                aria-label="Họ và tên" required>
                        </div>
                    </div>

                    <!-- username -->
                    <div class="field">
                        <label for="username">Tên đăng nhập</label>
                        <div class="input" title="Tên đăng nhập">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                <path d="M12 12c2.7 0 4.9-2.2 4.9-4.9S14.7 2.2 12 2.2 7.1 4.4 7.1 7.1 9.3 12 12 12z"
                                    fill="#9CA3AF" />
                                <path d="M4 20.4c0-3.3 4.1-5 8-5s8 1.7 8 5v.6H4v-.6z" fill="#9CA3AF" />
                            </svg>
                            <input id="username" name="username" type="text" placeholder="username"
                                aria-label="Tên đăng nhập" required>
                        </div>
                    </div>

                    <!-- email -->
                    <div class="field">
                        <label for="email">Email</label>
                        <div class="input">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                <path d="M3 7.2v9.6a2 2 0 002 2h14a2 2 0 002-2V7.2L12 13 3 7.2z" fill="#9CA3AF" />
                                <path d="M21 6H3l9 6 9-6z" fill="#9CA3AF" />
                            </svg>
                            <input id="email" name="email" type="email" placeholder="name@company.com"
                                aria-label="Email" required>
                        </div>
                    </div>

                    <!-- password -->
                    <div class="field">
                        <label for="password">Mật khẩu</label>
                        <div class="input">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                <path
                                    d="M17 8h-1V6a4 4 0 00-8 0v2H7a1 1 0 00-1 1v9a1 1 0 001 1h10a1 1 0 001-1v-9a1 1 0 00-1-1z"
                                    fill="#9CA3AF" />
                            </svg>
                            <input id="password" name="password" type="password" placeholder="Ít nhất 8 ký tự"
                                aria-label="Mật khẩu" required>
                            <button id="togglePwd" type="button" aria-label="Hiện mật khẩu"
                                style="border:0;background:transparent;cursor:pointer;padding:6px;">
                                <svg id="eyeIcon" width="18" height="18" viewBox="0 0 24 24" fill="none"
                                    aria-hidden="true">
                                    <path d="M12 5c-7 0-10 6.9-10 7s3 7 10 7 10-6.9 10-7-3-7-10-7z" stroke="#9CA3AF"
                                        stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" />
                                    <circle cx="12" cy="12" r="3" fill="#9CA3AF" />
                                </svg>
                            </button>
                        </div>
                        <div class="small-note">Mật khẩu nên có ít nhất 8 ký tự, bao gồm chữ và số.</div>
                    </div>

                    <!-- confirm password -->
                    <div class="field">
                        <label for="confirmPassword">Xác nhận mật khẩu</label>
                        <div class="input">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                <path d="M12 12c2.7 0 4.9-2.2 4.9-4.9S14.7 2.2 12 2.2 7.1 4.4 7.1 7.1 9.3 12 12 12z"
                                    fill="#9CA3AF" />
                            </svg>
                            <input id="confirmPassword" name="confirm_password" type="password"
                                placeholder="Nhập lại mật khẩu" aria-label="Xác nhận mật khẩu" required>
                            <button id="toggleConfirmPwd" type="button" aria-label="Hiện mật khẩu"
                                style="border:0;background:transparent;cursor:pointer;padding:6px;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                    <path d="M12 5c-7 0-10 6.9-10 7s3 7 10 7 10-6.9 10-7-3-7-10-7z" stroke="#9CA3AF"
                                        stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" />
                                    <circle cx="12" cy="12" r="3" fill="#9CA3AF" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- referral code -->
                    <div class="field">
                        <label for="referral_code">Mã giới thiệu (nếu có)</label>
                        <div class="input">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                <path d="M3 12h8M21 12h-8M12 3v8M12 21v-8" stroke="#9CA3AF" stroke-width="1.4"
                                    stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <input id="referral_code" name="referral_code" type="text"
                                placeholder="Nhập mã giới thiệu (nếu có)" aria-label="Mã giới thiệu">
                        </div>
                    </div>

                    <label class="remember" style="margin-top:6px;">
                        <input id="agree" type="checkbox" aria-label="Đồng ý điều khoản"> Tôi đồng ý với <a
                            href="/terms" class="muted-link" style="margin-left:6px;">Điều khoản dịch vụ</a>
                    </label>

                    <div style="margin-top:8px;">
                        <button id="btnRegister" class="btn" type="submit" aria-live="polite">
                            <span id="btnText">Đăng ký</span>
                            <span id="btnSpinner" style="display:none;margin-left:6px;">
                                <span class="spinner" aria-hidden="true"></span>
                            </span>
                        </button>
                    </div>

                    <div class="links" style="margin-top:8px;">
                        <div class="helper">Đã có tài khoản?</div>
                        <a href="/user/login" class="muted-link">Đăng nhập</a>
                    </div>
                </form>
            </div>

        </div>
    </div>

    <script>
        // Toggle password show/hide cho cả 2 input
        function toggleVisibility(inputId, iconEl) {
            const input = document.getElementById(inputId);
            if (!input) return;
            const svg = iconEl.querySelector('svg');
            if (input.type === 'password') {
                input.type = 'text';
                if (svg) svg.innerHTML =
                    '<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7S2 12 2 12z" stroke="#9CA3AF" stroke-width="1.2" fill="none"/><circle cx="12" cy="12" r="3" fill="#fff"/>';
            } else {
                input.type = 'password';
                if (svg) svg.innerHTML =
                    '<path d="M12 5c-7 0-10 6.9-10 7s3 7 10 7 10-6.9 10-7-3-7-10-7z" stroke="#9CA3AF" stroke-width="1.2"/><circle cx="12" cy="12" r="3" fill="#9CA3AF"/>';
            }
        }
        document.getElementById('togglePwd').addEventListener('click', function () { toggleVisibility('password', this); });
        document.getElementById('toggleConfirmPwd').addEventListener('click', function () { toggleVisibility('confirmPassword', this); });

        const form = document.getElementById('registerForm');
        const errorBox = document.getElementById('errorBox');
        const successBox = document.getElementById('successBox');


        function showError(msg) {
            errorBox.style.display = 'block';
            errorBox.textContent = msg;
            successBox.style.display = 'none';
        }
        function showSuccess(msg) {
            successBox.style.display = 'block';
            successBox.textContent = msg;
            errorBox.style.display = 'none';
        }
        function clearMessages() { errorBox.style.display = 'none'; successBox.style.display = 'none'; }

        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        async function submitRegister() {
            clearMessages();

            const username = document.getElementById('username').value.trim();
            const fullname = document.getElementById('fullname').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const confirm = document.getElementById('confirmPassword').value;
            const referral_code = document.getElementById('referral_code').value.trim() || null;
            const agree = document.getElementById('agree').checked;

            if (!username || !fullname || !email || !password || !confirm) {
                showError('Vui lòng nhập đầy đủ thông tin.');
                return;
            }
            if (!validateEmail(email)) { showError('Email không hợp lệ.'); return; }
            if (password.length < 8) { showError('Mật khẩu phải có ít nhất 8 ký tự.'); return; }
            if (password !== confirm) { showError('Mật khẩu xác nhận không khớp.'); return; }
            if (!agree) { showError('Bạn phải đồng ý với Điều khoản dịch vụ.'); return; }

            const btn = document.getElementById('btnRegister');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');

            btn.disabled = true;
            btnText.textContent = 'Đang xử lý...';
            btnSpinner.style.display = 'inline-block';

            try {
                // --- Gọi API đăng ký ---
                const payload = { username, fullname, email, password, referral_code };
                const res = await fetch('/user/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                if (!data.success) {
                    showError(data.message || 'Đăng ký thất bại.');
                    return;
                }

                // --- Tạo ví điểm mặc định ---
                try {
                    await fetch("/point/wallet/init", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ user_id: data.user_id })
                    });
                } catch (e) {
                    console.warn("Không tạo được PointWallet mặc định:", e);
                }

                // --- Nếu có referral thì cộng điểm ---
                if (data.referred_by) {
                    const rewardPoints = 50; // số điểm thưởng mặc định

                    try {
                        await fetch("/point/earn_referral_pair", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                new_user_id: data.user_id,
                                referrer_id: data.referred_by,
                                points: rewardPoints
                            })
                        });
                    } catch (e) {
                        console.warn("Không cộng được điểm referral:", e);
                    }
                }

                alert('Đăng ký thành công! Chuyển hướng đến đăng nhập...');
                setTimeout(() => { window.location.href = '/user/login'; }, 1000);

            } catch (err) {
                console.error(err);
                showError('Có lỗi xảy ra khi đăng ký.');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Đăng ký';
                btnSpinner.style.display = 'none';
            }
        }



        form.addEventListener('submit', (e) => { e.preventDefault(); submitRegister(); });
        Array.from(form.querySelectorAll('input')).forEach(inp => {
            inp.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); submitRegister(); } });
        });
    </script>

</body>

</html>