<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Quên mật khẩu — Loyalty Point System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f5f9ff;
            --accent: #2563eb;
            --muted: #6b7280;
            --card: #fff;
            --danger: #ef4444;
            --success: #10b981
        }

        * {
            box-sizing: border-box;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
        }

        body {
            margin: 0;
            background: linear-gradient(180deg, var(--bg), #fff);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 28px
        }

        .card {
            width: 100%;
            max-width: 520px;
            background: var(--card);
            border-radius: 12px;
            padding: 28px;
            box-shadow: 0 8px 30px rgba(2, 6, 23, 0.06)
        }

        h1 {
            margin: 0 0 6px 0;
            color: var(--accent);
            font-size: 28px
        }

        p.desc {
            margin: 0 0 18px 0;
            color: var(--muted)
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #374151
        }

        .input {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #e6e9ef;
            background: #fff
        }

        .input input {
            border: 0;
            outline: none;
            width: 100%;
            font-size: 15px;
            padding: 4px 0
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 11px 14px;
            border-radius: 10px;
            border: 0;
            background: linear-gradient(90deg, var(--accent), #1e40af);
            color: #fff;
            font-weight: 700;
            cursor: pointer
        }

        .helper {
            font-size: 13px;
            color: var(--muted);
            margin-top: 12px
        }

        .msg {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: none;
            font-size: 14px
        }

        .msg.error {
            background: #fff4f4;
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.12)
        }

        .msg.success {
            background: #f0fdf4;
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.08)
        }

        a.link {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600
        }

        a.link:hover {
            text-decoration: underline
        }
    </style>
</head>

<body>
    <div class="card" role="main" aria-labelledby="title">
        <h1 id="title">Quên mật khẩu</h1>
        <p class="desc">Nhập email bạn đã dùng khi đăng ký. Chúng tôi sẽ gửi link để đặt lại mật khẩu.</p>

        <div id="msg" class="msg" role="alert"></div>

        <form id="forgotForm" onsubmit="return false;">
            <label for="email">Email</label>
            <div class="input">
                <input id="email" type="email" placeholder="name@company.com" required aria-label="Email">
            </div>

            <div style="margin-top:14px;display:flex;gap:10px;align-items:center">
                <button id="btnSend" class="btn" type="submit">Gửi yêu cầu</button>
                <div id="spinner"
                    style="display:none;width:18px;height:18px;border:3px solid rgba(255,255,255,0.35);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite">
                </div>
            </div>

            <p class="helper">Nếu bạn không nhận được email, kiểm tra thư mục Spam hoặc thử lại sau vài phút.</p>
            <p class="helper" style="margin-top:12px">
                <a class="link" href="/user/login">Quay về trang đăng nhập</a>
            </p>
        </form>
    </div>

    <script>
        function showMessage(type, text) {
            const el = document.getElementById('msg');
            el.className = 'msg ' + (type === 'error' ? 'error' : 'success');
            el.textContent = text;
            el.style.display = 'block';
        }
        function clearMessage() { const el = document.getElementById('msg'); el.style.display = 'none'; el.textContent = ''; }

        async function submitForgot() {
            clearMessage();
            const email = document.getElementById('email').value.trim();
            if (!email) return showMessage('error', 'Vui lòng nhập email.');

            const btn = document.getElementById('btnSend');
            const spinner = document.getElementById('spinner');
            btn.disabled = true; spinner.style.display = 'inline-block';

            try {
                const res = await fetch('/user/forgot_password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json().catch(() => null);
                if (res.ok && data && data.success) {
                    showMessage('success', data.message || 'Mã xác thực đã được gửi.');
                    setTimeout(() => {
                        window.location.href = `/user/reset_password_page?email=${encodeURIComponent(email)}`;
                    }, 1200);
                }
                else {
                    showMessage('error', (data && (data.message || data.error)) || 'Yêu cầu thất bại. Vui lòng thử lại.');
                }
            } catch (err) {
                console.error(err);
                showMessage('error', 'Không thể kết nối tới server. Vui lòng thử lại.');
            } finally {
                btn.disabled = false; spinner.style.display = 'none';
            }
        }

        document.getElementById('forgotForm').addEventListener('submit', (e) => { e.preventDefault(); submitForgot(); });
        // spinner animation
        (function () { const s = document.createElement('style'); s.innerHTML = '@keyframes spin{to{transform:rotate(360deg);}}'; document.head.appendChild(s); })();
    </script>
</body>

</html>